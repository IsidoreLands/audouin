apiVersion: 1

groups:
  - name: Node Downtime
    folder: Redis Failover
    interval: 1m
    rules:

      # --- Alert 4: Torta Exporter Down (Password Mismatch) ---
      - uid: 'exporter_down_torta'
        title: 'Exporter Down - Torta'
        condition: C
        for: 2m
        data:
          - refId: A
            datasourceUid: 'prometheus'
            relativeTimeRange:
              from: 600
              to: 0
            model:
              expr: 'up{job="sentinel", instance="10.8.1.4:9355"} == 0'
              instant: true
              refId: A
          - refId: C
            datasourceUid: '__expr__'
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: 'threshold'
              expression: 'A'
              conditions:
                - evaluator:
                    params: [0]
                    type: 'gt'
                  operator:
                    type: 'and'
                  query:
                    params: [C]
                  reducer:
                    params: []
                    type: 'last'
                  type: 'query'
        noDataState: NoData
        execErrState: Error
        annotations:
          description: 'The sentinel exporter on {{ $labels.instance }} (torta) is unreachable.'
          summary: 'Exporter down on torta (check for password mismatch or container crash)'

      # --- Alert 7: Node Downtime ---
      - uid: 'node_down'
        title: 'Node Downtime'
        condition: C
        for: 5m
        data:
          - refId: A
            datasourceUid: 'prometheus'
            relativeTimeRange:
              from: 600
              to: 0
            model:
              expr: 'up == 0'
              instant: true
              refId: A
          - refId: C
            datasourceUid: '__expr__'
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: 'threshold'
              expression: 'A'
              conditions:
                - evaluator:
                    params: [0]
                    type: 'gt'
                  operator:
                    type: 'and'
                  query:
                    params: [C]
                  reducer:
                    params: []
                    type: 'last'
                  type: 'query'
        noDataState: NoData
        execErrState: Error
        annotations:
          description: 'Node {{ $labels.instance }} is down—check Digital Ocean status or maintenance'
          summary: 'Node/exporter downtime detected'

      # --- Alert 8: All Nodes Down (Catastrophic Outage) ---
      - uid: 'all_nodes_down'
        title: 'All Nodes Down'
        condition: C
        for: 10m
        data:
          - refId: A
            datasourceUid: 'prometheus'
            relativeTimeRange:
              from: 600
              to: 0
            model:
              expr: 'count(up == 0) == count(up)'
              instant: true
              refId: A
          - refId: C
            datasourceUid: '__expr__'
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: 'threshold'
              expression: 'A'
              conditions:
                - evaluator:
                    params: [0]
                    type: 'gt'
                  operator:
                    type: 'and'
                  query:
                    params: [C]
                  reducer:
                    params: []
                    type: 'last'
                  type: 'query'
        noDataState: NoData
        execErrState: Error
        annotations:
          description: 'All monitored nodes/exporters are down—possible Digital Ocean outage'
          summary: 'Catastrophic cluster downtime detected'
